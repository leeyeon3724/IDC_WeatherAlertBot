name: Live E2E

on:
  schedule:
    - cron: "30 19 * * 1"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: live-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-live-e2e:
    runs-on: ubuntu-latest
    environment:
      name: live-e2e
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Live E2E preflight
        id: preflight
        env:
          LIVE_E2E_SERVICE_API_KEY: ${{ secrets.LIVE_E2E_SERVICE_API_KEY }}
          LIVE_E2E_WEBHOOK_URL: ${{ secrets.LIVE_E2E_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          missing=()
          [[ -z "${LIVE_E2E_SERVICE_API_KEY:-}" ]] && missing+=("secrets.LIVE_E2E_SERVICE_API_KEY")
          [[ -z "${LIVE_E2E_WEBHOOK_URL:-}" ]] && missing+=("secrets.LIVE_E2E_WEBHOOK_URL")

          if [[ ${#missing[@]} -gt 0 ]]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "missing=${missing[*]}" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "missing=" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip summary
        if: steps.preflight.outputs.should_run != 'true'
        run: |
          printf '## Live E2E\n\n- status: SKIPPED\n- reason: missing required secrets (%s)\n' \
            "${{ steps.preflight.outputs.missing }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Run service live-e2e
        if: steps.preflight.outputs.should_run == 'true'
        id: run_service
        env:
          SERVICE_API_KEY: ${{ secrets.LIVE_E2E_SERVICE_API_KEY }}
          SERVICE_HOOK_URL: ${{ secrets.LIVE_E2E_WEBHOOK_URL }}
          LIVE_E2E_AREA_CODES: ${{ vars.LIVE_E2E_AREA_CODES }}
          LIVE_E2E_AREA_CODE_MAPPING: ${{ vars.LIVE_E2E_AREA_CODE_MAPPING }}
        run: |
          set -euo pipefail
          mkdir -p artifacts/live-e2e/data
          AREA_CODES_VALUE='["L1090000"]'
          AREA_CODE_MAPPING_VALUE='{"L1090000":"서울"}'
          if [[ -n "${LIVE_E2E_AREA_CODES:-}" ]]; then
            AREA_CODES_VALUE="$LIVE_E2E_AREA_CODES"
          fi
          if [[ -n "${LIVE_E2E_AREA_CODE_MAPPING:-}" ]]; then
            AREA_CODE_MAPPING_VALUE="$LIVE_E2E_AREA_CODE_MAPPING"
          fi

          export AREA_CODES="$AREA_CODES_VALUE"
          export AREA_CODE_MAPPING="$AREA_CODE_MAPPING_VALUE"
          export SENT_MESSAGES_FILE="./artifacts/live-e2e/data/sent_messages.live-e2e.json"
          export SQLITE_STATE_FILE="./artifacts/live-e2e/data/sent_messages.live-e2e.db"
          export HEALTH_STATE_FILE="./artifacts/live-e2e/data/api_health_state.live-e2e.json"
          export STATE_REPOSITORY_TYPE="sqlite"
          export RUN_ONCE="true"
          export DRY_RUN="false"
          export LOOKBACK_DAYS="0"
          export CYCLE_INTERVAL_SEC="0"
          export AREA_INTERVAL_SEC="0"
          export LOG_LEVEL="INFO"
          export TIMEZONE="Asia/Seoul"

          set +e
          python main.py run > artifacts/live-e2e/service.log 2>&1
          service_exit_code=$?
          set -e

          echo "service_exit_code=$service_exit_code" >> "$GITHUB_OUTPUT"

      - name: Probe webhook delivery path
        if: steps.preflight.outputs.should_run == 'true'
        id: probe_webhook
        env:
          SERVICE_HOOK_URL: ${{ secrets.LIVE_E2E_WEBHOOK_URL }}
          WEBHOOK_PROBE_FILE: artifacts/live-e2e/webhook_probe.json
        run: |
          set -euo pipefail
          mkdir -p artifacts/live-e2e
          set +e
          python - <<'PY'
          from __future__ import annotations

          import json
          import os
          from datetime import UTC, datetime

          from app.services.notifier import DoorayNotifier

          output = os.environ["WEBHOOK_PROBE_FILE"]
          webhook_url = os.environ["SERVICE_HOOK_URL"]
          result = {
              "passed": False,
              "error": "",
              "timestamp_utc": datetime.now(UTC).isoformat(),
          }
          try:
              notifier = DoorayNotifier(
                  hook_url=webhook_url,
                  bot_name="weather-alert-live-e2e",
                  timeout_sec=5,
                  connect_timeout_sec=5,
                  read_timeout_sec=5,
                  max_retries=2,
                  retry_delay_sec=1,
              )
              notifier.send(
                  "[live-e2e] webhook delivery probe "
                  + datetime.now(UTC).strftime("%Y-%m-%dT%H:%M:%SZ")
              )
              result["passed"] = True
          except Exception as exc:
              result["error"] = str(exc)

          with open(output, "w", encoding="utf-8") as file:
              json.dump(result, file, ensure_ascii=False, indent=2, sort_keys=True)

          raise SystemExit(0 if result["passed"] else 1)
          PY
          webhook_probe_exit_code=$?
          set -e

          echo "webhook_probe_exit_code=$webhook_probe_exit_code" >> "$GITHUB_OUTPUT"

      - name: Build live-e2e report
        if: steps.preflight.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          python -m scripts.canary_report \
            --log-file artifacts/live-e2e/service.log \
            --service-exit-code "${{ steps.run_service.outputs.service_exit_code }}" \
            --webhook-probe-file artifacts/live-e2e/webhook_probe.json \
            --json-output artifacts/live-e2e/report.json \
            --markdown-output artifacts/live-e2e/report.md
          cat artifacts/live-e2e/report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Build live-e2e SLO report
        if: steps.preflight.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          python -m scripts.slo_report \
            --log-file artifacts/live-e2e/service.log \
            --min-success-rate 1.0 \
            --max-failure-rate 0.0 \
            --max-p95-cycle-latency-sec 600 \
            --max-pending-latest 0 \
            --json-output artifacts/live-e2e/slo_report.json \
            --markdown-output artifacts/live-e2e/slo_report.md
          cat artifacts/live-e2e/slo_report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload live-e2e artifacts
        if: always() && steps.preflight.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: live-e2e-${{ github.run_id }}
          path: artifacts/live-e2e
          if-no-files-found: warn
